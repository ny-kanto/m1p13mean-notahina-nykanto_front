<app-header></app-header>

<div class="product-detail-container">
  <!-- Bouton retour -->
  <button class="btn-back" (click)="goBack()">
    <i class="fas fa-arrow-left"></i>
    Retour à la liste
  </button>

  <!-- État de chargement -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Chargement du produit...</p>
    </div>
  }

  <!-- Message d'erreur -->
  @if (errorMessage && !isLoading) {
    <div class="error-state">
      <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <h3>Erreur</h3>
      <p>{{ errorMessage }}</p>
      <button class="btn-retry" (click)="loadProduct()">
        <i class="fas fa-redo"></i> Réessayer
      </button>
    </div>
  }

  <!-- Détails du produit -->
  @if (product && !isLoading && !errorMessage) {
    <div class="product-detail-content">
      <!-- ========== COLONNE GAUCHE : Galerie d'images ========== -->
      <div class="product-gallery">
        <!-- Image principale -->
        <div class="main-image-container">
          @if (product.images && product.images.length > 0) {
            <img
              [src]="product.images[selectedImageIndex]?.url"
              [alt]="product.nom"
              class="main-image"
            />

            @if (product.images.length > 1) {
              <button type="button" class="nav-btn prev-btn" (click)="previousImage()">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button type="button" class="nav-btn next-btn" (click)="nextImage()">
                <i class="fas fa-chevron-right"></i>
              </button>
            }
          } @else {
            <img
              src="https://via.placeholder.com/600x600?text=Aucune+image"
              alt="Pas d'image"
              class="main-image"
            />
          }
        </div>

        <!-- Miniatures -->
        @if (product.images && product.images.length > 1) {
          <div class="thumbnails">
            @for (image of product.images; track $index) {
              <div
                class="thumbnail"
                [class.active]="selectedImageIndex === $index"
                (click)="selectImage($index)"
              >
                <img [src]="image.url" [alt]="product.nom + ' - Image ' + ($index + 1)" />
              </div>
            }
          </div>
        }
      </div>

      <!-- ========== COLONNE DROITE : Informations ========== -->
      <div class="product-info">
        <h1 class="product-name">{{ product.nom }}</h1>

        <div class="product-price">
          <span class="price-amount">{{ product.prix }}</span>
          <span class="currency">Ar</span>
        </div>
        <div
          class="product-rating"
          *ngIf="product.noteCompte && product.noteCompte > 0; else noRating"
        >
          <div class="rating-stars">
            @for (star of [1, 2, 3, 4, 5]; track star) {
              <ng-container [ngSwitch]="getStarType(star, product.noteMoyenne)">
                <i *ngSwitchCase="'full'" class="fas fa-star star-full"></i>

                <i *ngSwitchCase="'half'" class="fas fa-star-half-alt star-half"></i>

                <i *ngSwitchDefault class="far fa-star star-empty"></i>
              </ng-container>
            }
          </div>

          <span class="rating-summary">
            {{ product.noteMoyenne || 0 | number: '1.1-1' }}/5 ({{ product.noteCompte }} avis)
          </span>
        </div>

        <ng-template #noRating>
          <div class="product-rating">
            <span class="rating-summary">Aucun avis</span>
          </div>
        </ng-template>

        <hr class="divider" />

        <div class="product-description">
          <h3><i class="fas fa-align-left"></i> Description</h3>
          @if (product.description) {
            <p>{{ product.description }}</p>
          } @else {
            <p class="no-description">Aucune description disponible</p>
          }
        </div>

        <div class="product-details">
          <h3><i class="fas fa-info-circle"></i> Détails</h3>
          <ul class="details-list">
            <li>
              <span class="detail-label">Référence :</span>
              <span class="detail-value">{{ product._id }}</span>
            </li>
            <li>
              <span class="detail-label">Prix unitaire :</span>
              <span class="detail-value">{{ product.prix }} Ar</span>
            </li>
          </ul>
        </div>

        <hr class="divider" />

        <!-- ========== FORMULAIRE AVIS ========== -->
        <div class="review-section">
          <h3><i class="fas fa-star"></i> Donnez votre avis</h3>

          <!-- Messages succès/erreur -->
          @if (sendSuccess) {
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i>
              {{ sendSuccess }}
            </div>
          }
          @if (sendError) {
            <div class="alert alert-error">
              <i class="fas fa-exclamation-circle"></i>
              {{ sendError }}
            </div>
          }

          <!-- Sélection note (étoiles) -->
          <div class="rating-container">
            <label class="rating-label">Votre note :</label>
            <div class="stars-rating">
              @for (star of [1, 2, 3, 4, 5]; track star) {
                <button
                  type="button"
                  class="star-btn"
                  [class.on]="star <= (hover || myNote)"
                  [class.off]="star > (hover || myNote)"
                  (click)="setNote(star)"
                  (mouseenter)="setHover(star)"
                  (mouseleave)="setHover(0)"
                  aria-label="Donner {{ star }} étoile(s)"
                >
                  <span class="star">&#9733;</span>
                </button>
              }
            </div>
            <span class="rating-text">{{ myNote }} / 5</span>
          </div>

          <!-- Commentaire -->
          <div class="comment-container">
            <label class="comment-label" for="myCommentaire">Votre commentaire :</label>
            <textarea
              id="myCommentaire"
              class="comment-textarea"
              [(ngModel)]="myCommentaire"
              placeholder="Partagez votre expérience avec ce produit..."
              rows="4"
              maxlength="500"
            ></textarea>
            <div class="comment-info">
              <span class="char-count">{{ myCommentaire.length }} / 500</span>
            </div>
          </div>

          <!-- Bouton soumettre -->
          <button
            class="btn-submit-review"
            type="button"
            (click)="submitAvis()"
            [disabled]="sendingAvis || myCommentaire.trim() === ''"
          >
            @if (sendingAvis) {
              <i class="fas fa-spinner fa-spin"></i>
              Envoi en cours...
            } @else {
              <i class="fas fa-paper-plane"></i>
              Publier mon avis
            }
          </button>
        </div>

        <hr class="divider" />

        <!-- ========== LISTE DES AVIS ========== -->
        <div class="reviews-list-section">
          <h3><i class="fas fa-comments"></i> Avis des clients</h3>

          @if (avisLoading) {
            <div class="avis-loading">
              <div class="spinner-small"></div>
              <p>Chargement des avis...</p>
            </div>
          }

          @if (avisError && !avisLoading) {
            <div class="alert alert-error">
              <i class="fas fa-exclamation-triangle"></i>
              {{ avisError }}
            </div>
          }

          @if (!avisLoading && avis.length === 0) {
            <div class="no-reviews">
              <i class="fas fa-inbox"></i>
              <p>Aucun avis pour le moment. Soyez le premier à donner votre avis !</p>
            </div>
          }

          @if (!avisLoading && avis.length > 0) {
            <div class="reviews-list">
              @for (a of avis; track a._id) {
                <div class="review-item">
                  <div class="review-header">
                    <div class="review-user">
                      <i class="fas fa-user-circle"></i>
                      <span class="user-name">{{ userName(a) }}</span>
                    </div>
                    <div class="review-rating">
                      @for (star of [1, 2, 3, 4, 5]; track star) {
                        <i
                          class="fas fa-star"
                          [class.star-full]="star <= a.note"
                          [class.star-empty]="star > a.note"
                        ></i>
                      }
                    </div>
                  </div>
                  <div class="review-content">
                    <p>{{ a.commentaire }}</p>
                  </div>
                  <div class="review-footer">
                    <span class="review-date">{{ a.created_at | date: 'dd/MM/yyyy' }}</span>
                    <!-- Bouton supprimer (si c'est l'auteur) -->
                    <button
                      type="button"
                      class="btn-delete-review"
                      (click)="deleteAvis(a._id)"
                      title="Supprimer"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>

<app-footer></app-footer>
